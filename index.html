<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuantumEarth :: Multi-API Seismic Monitor</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        :root {
            --bg-color: #050507;
            --panel-bg: rgba(10, 10, 12, 0.9);
            --text-main: #ffffff;
            --text-sub: #a0a0a0;
            --accent: #00f2fe;
            --danger: #ff0055;
            --warning: #ffcc00;
            --border: rgba(255, 255, 255, 0.1);
            --font-family: 'Inter', system-ui, sans-serif;
        }

        [data-theme="light"] {
            --bg-color: #f0f2f5;
            --panel-bg: rgba(255, 255, 255, 0.95);
            --text-main: #1a1a1a;
            --text-sub: #555555;
            --accent: #0077ff;
            --border: rgba(0, 0, 0, 0.1);
        }

        body { margin: 0; font-family: var(--font-family); background: var(--bg-color); color: var(--text-main); overflow: hidden; height: 100vh; transition: all 0.3s; }

        /* Header */
        header { position: absolute; top: 10px; left: 10px; z-index: 1000; background: var(--panel-bg); backdrop-filter: blur(10px); padding: 10px 15px; border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        header h1 { margin: 0; font-size: 0.9em; letter-spacing: 2px; text-transform: uppercase; }
        header h1 span { color: var(--accent); }
        .live-badge { color: var(--danger); font-size: 0.7em; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .live-dot { width: 7px; height: 7px; background: var(--danger); border-radius: 50%; animation: pulse 1.5s infinite; }
        #countdown { font-size: 0.7em; color: var(--text-sub); }

        /* Theme Toggle */
        #themeToggle { position: absolute; top: 10px; right: 10px; z-index: 1000; background: var(--panel-bg); border: 1px solid var(--border); color: var(--text-main); padding: 8px; border-radius: 8px; cursor: pointer; backdrop-filter: blur(10px); }

        /* Map */
        #map { height: 100vh; width: 100%; z-index: 1; }

        /* Shutter Panel (Draggable) */
        .shutter {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40vh;
            background: var(--panel-bg);
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--border);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            z-index: 1001;
            transition: height 0.3s ease;
            display: flex;
            flex-direction: column;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.4);
        }
        .shutter-handle {
            width: 50px;
            height: 6px;
            background: var(--text-sub);
            border-radius: 3px;
            margin: 10px auto;
            cursor: ns-resize;
        }
        .shutter-content { padding: 0 20px 20px 20px; overflow-y: auto; flex-grow: 1; }

        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 15px; border-bottom: 1px solid var(--border); padding-bottom: 10px; }
        .tab-btn { background: none; border: none; color: var(--text-sub); padding: 8px 15px; cursor: pointer; font-size: 0.85em; font-weight: bold; border-radius: 4px; }
        .tab-btn.active { background: var(--accent); color: #fff; }

        /* Table Styling */
        table { width: 100%; border-collapse: collapse; font-size: 0.8em; }
        th { text-align: left; color: var(--text-sub); padding: 10px; font-size: 0.75em; letter-spacing: 1px; }
        tbody tr { border-bottom: 1px solid var(--border); cursor: pointer; }
        tbody tr:hover { background: rgba(255,255,255,0.05); }
        td { padding: 12px 10px; }
        .mag-high { color: var(--danger); font-weight: bold; }
        .mag-med { color: var(--warning); font-weight: bold; }
        .mag-low { color: var(--accent); font-weight: bold; }

        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(255, 0, 85, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 0, 85, 0); } }
        
        /* Popup */
        .leaflet-popup-content-wrapper { background: var(--panel-bg); color: var(--text-main); border: 1px solid var(--border); }
        .leaflet-popup-tip { background: var(--panel-bg); }
    </style>
</head>
<body>

<header>
    <h1>Quantum<span>Earth</span></h1>
    <div class="live-badge"><div class="live-dot"></div> LIVE</div>
    <div id="countdown">Refresh in: 60s</div>
</header>

<button id="themeToggle" onclick="toggleTheme()">üåì</button>

<div id="map"></div>

<div class="shutter" id="shutter">
    <div class="shutter-handle" id="handle"></div>
    <div class="shutter-content">
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('live')">‡ß®‡ß™ ‡¶ò‡¶£‡ßç‡¶ü‡¶æ (‡¶≤‡¶æ‡¶á‡¶≠)</button>
            <button class="tab-btn" onclick="showTab('history')">‡ß©‡ß¶ ‡¶¶‡¶ø‡¶® (‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø)</button>
        </div>
        
        <div id="liveTab" class="tab-content">
            <table id="liveTable">
                <thead><tr><th>‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®</th><th>‡¶§‡ßÄ‡¶¨‡ßç‡¶∞‡¶§‡¶æ</th><th>‡¶ó‡¶≠‡ßÄ‡¶∞‡¶§‡¶æ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
        
        <div id="historyTab" class="tab-content" style="display:none;">
            <table id="historyTable">
                <thead><tr><th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</th><th>‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®</th><th>‡¶§‡ßÄ‡¶¨‡ßç‡¶∞‡¶§‡¶æ</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Theme Toggle
    function toggleTheme() {
        const body = document.body;
        const currentTheme = body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        body.setAttribute('data-theme', currentTheme);
        localStorage.setItem('theme', currentTheme);
        location.reload(); 
    }
    const savedTheme = localStorage.getItem('theme') || 'dark';
    document.body.setAttribute('data-theme', savedTheme);

    // Map Setup
    const map = L.map('map', { zoomControl: false }).setView([23.6850, 90.3563], 7);
    const tileUrl = savedTheme === 'dark' 
        ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
        : 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
    L.tileLayer(tileUrl).addTo(map);
    L.control.zoom({ position: 'bottomright' }).addTo(map);

    // Fault Lines
    const faultLines = [
        [[25.0, 90.0], [25.5, 92.5]],
        [[21.0, 91.5], [24.5, 93.5]]
    ];
    faultLines.forEach(line => L.polyline(line, {color: '#ff4757', weight: 2, opacity: 0.6}).addTo(map));

    const markersGroup = L.layerGroup().addTo(map);
    let countdown = 60;

    async function fetchData() {
        markersGroup.clearLayers();
        
        // Define APIs
        const usgsUrl = "https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson&maxlatitude=27&minlatitude=20&maxlongitude=94&minlongitude=87";
        const emscUrl = "https://www.seismicportal.eu/fdsnws/event/1/query?format=json&maxlatitude=27&minlatitude=20&maxlongitude=94&minlongitude=87";

        try {
            // Using a CORS proxy to prevent blocking if necessary, 
            // but these APIs usually allow direct access.
            const [usgsRes, emscRes] = await Promise.all([
                fetch(`${usgsUrl}&starttime=NOW-30days&minmagnitude=3.0`),
                fetch(`${emscUrl}&start=NOW-30days&minmag=3.0`)
            ]);

            const usgsData = await usgsRes.json();
            const emscData = await emscRes.json();

            let mergedFeatures = [];
            
            // Normalize USGS
            usgsData.features.forEach(f => {
                mergedFeatures.push({
                    mag: f.properties.mag,
                    place: f.properties.place,
                    time: f.properties.time,
                    depth: f.geometry.coordinates[2],
                    lat: f.geometry.coordinates[1],
                    lon: f.geometry.coordinates[0],
                    source: 'USGS'
                });
            });

            // Normalize EMSC
            emscData.features.forEach(f => {
                const emscTime = new Date(f.properties.time).getTime();
                const isDuplicate = mergedFeatures.some(m => 
                    Math.abs(m.time - emscTime) < 60000 && 
                    Math.abs(m.lat - f.geometry.coordinates[1]) < 0.1
                );

                if (!isDuplicate) {
                    mergedFeatures.push({
                        mag: f.properties.mag,
                        place: f.properties.flynn_region || f.properties.place,
                        time: emscTime,
                        depth: f.geometry.coordinates[2],
                        lat: f.geometry.coordinates[1],
                        lon: f.geometry.coordinates[0],
                        source: 'EMSC'
                    });
                }
            });

            mergedFeatures.sort((a, b) => b.time - a.time);

            const now = new Date().getTime();
            const oneDay = 24 * 60 * 60 * 1000;
            
            const liveFeatures = mergedFeatures.filter(f => (now - f.time) < oneDay);
            const historyFeatures = mergedFeatures.filter(f => f.mag >= 4.0);

            renderTable(liveFeatures, 'liveTable', true);
            renderTable(historyFeatures, 'historyTable', false);

            countdown = 60;
        } catch (err) { 
            console.error(err);
            document.querySelector('#liveTable tbody').innerHTML = "<tr><td colspan='3' style='text-align:center;'>‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá‡•§</td></tr>";
        }
    }

    function renderTable(features, tableId, isLive) {
        const tbody = document.querySelector(`#${tableId} tbody`);
        tbody.innerHTML = "";
        
        if (features.length === 0) {
            tbody.innerHTML = "<tr><td colspan='3' style='text-align:center;'>‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§</td></tr>";
            return;
        }

        features.forEach(f => {
            const row = document.createElement("tr");
            const timeString = new Date(f.time).toLocaleString('en-US', { timeZone: 'Asia/Dhaka' });

            row.innerHTML = isLive 
                ? `<td>${f.place}</td><td class="${getMagClass(f.mag)}">${f.mag.toFixed(1)}</td><td>${f.depth.toFixed(0)} km</td>`
                : `<td>${new Date(f.time).toLocaleDateString()}</td><td>${f.place}</td><td class="${getMagClass(f.mag)}">${f.mag.toFixed(1)}</td>`;
            
            row.onclick = () => {
                map.flyTo([f.lat, f.lon], 8);
                createPopup(f.lat, f.lon, f);
            };
            tbody.appendChild(row);

            // Add Marker
            const marker = L.circleMarker([f.lat, f.lon], {
                radius: Math.max(f.mag * 2, 5),
                fillColor: getMagColor(f.mag),
                color: '#fff',
                weight: 1,
                fillOpacity: 0.7
            });
            marker.bindPopup(`<b>${f.place}</b><br>Mag: ${f.mag}<br>Time: ${timeString}<br>Source: ${f.source}`);
            markersGroup.addLayer(marker);
        });
    }

    function getMagClass(mag) { return mag >= 5 ? 'mag-high' : (mag >= 4 ? 'mag-med' : 'mag-low'); }
    function getMagColor(mag) { return mag >= 5 ? '#ff0055' : (mag >= 4 ? '#ffcc00' : '#00f2fe'); }
    function createPopup(lat, lon, f) {
        L.popup().setLatLng([lat, lon]).setContent(`<b>${f.place}</b><br>Magnitude: ${f.mag}<br>Depth: ${f.depth.toFixed(1)} km<br>Source: ${f.source}`).openOn(map);
    }

    function showTab(tab) {
        document.getElementById('liveTab').style.display = tab === 'live' ? 'block' : 'none';
        document.getElementById('historyTab').style.display = tab === 'history' ? 'block' : 'none';
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.innerText.includes(tab === 'live' ? '‡¶≤‡¶æ‡¶á‡¶≠' : '‡¶π‡¶ø‡¶∏‡ßç‡¶ü‡ßã‡¶∞‡¶ø')));
    }

    // Countdown Timer
    setInterval(() => {
        countdown--;
        document.getElementById('countdown').innerText = `Refresh in: ${countdown}s`;
        if (countdown <= 0) fetchData();
    }, 1000);

    // Draggable Shutter
    const shutter = document.getElementById('shutter');
    const handle = document.getElementById('handle');
    let isDragging = false;
    handle.addEventListener('mousedown', () => isDragging = true);
    window.addEventListener('mouseup', () => isDragging = false);
    window.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        const newHeight = window.innerHeight - e.clientY;
        if (newHeight > 100 && newHeight < window.innerHeight - 50) {
            shutter.style.height = newHeight + 'px';
        }
    });

    fetchData();
</script>
</body>
</html>
