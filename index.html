<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pro Bangladesh Earthquake Monitor</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
:root {
    --bg-color: #121212;
    --card-bg: #1e1e1e;
    --text-color: #e0e0e0;
    --accent-red: #ff5252;
    --primary-green: #4caf50;
    --table-hover: #252525;
}
[data-theme="light"] {
    --bg-color: #f4f4f4;
    --card-bg: #ffffff;
    --text-color: #333333;
    --table-hover: #f0f0f0;
}
body { margin:0; font-family: 'Segoe UI', Roboto, sans-serif; background: var(--bg-color); color: var(--text-color); transition: all 0.3s; }
header { background: var(--card-bg); padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent-red); }
h1 { margin: 0; color: #fff; font-size: 1.5em; }
[data-theme="light"] h1 { color: #333; }
#map { height: 60vh; width: 100%; z-index: 1; }
.container { padding: 20px; max-width: 1200px; margin: auto; }
.status-panel { background: var(--card-bg); padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 10px; border: 1px solid #444; }
.live-indicator { color: var(--primary-green); font-weight: bold; animation: blink 1s infinite; }
@keyframes blink { 50% { opacity: 0; } }
.controls { display: flex; gap: 10px; }
button { padding: 8px 12px; cursor: pointer; border-radius: 4px; border: 1px solid #555; background: var(--card-bg); color: var(--text-color); }
.table-section { background: var(--card-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 0.9em; }
th, td { border-bottom: 1px solid #333; padding: 12px; text-align: left; }
[data-theme="light"] th, [data-theme="light"] td { border-bottom: 1px solid #ddd; }
th { color: var(--primary-green); }
tr:hover { background-color: var(--table-hover); }
.loading { text-align: center; padding: 20px; color: #aaa; }

/* Dynamic Pulsing markers */
.leaflet-marker-icon.pulse {
  border-radius: 50%;
  background: rgba(255,0,0,0.5);
  border: 2px solid #fff;
  animation: pulse 1.5s infinite;
}
@keyframes pulse {
  0% { transform: scale(0.7); opacity:0.7; }
  50% { transform: scale(1.5); opacity:0; }
  100% { transform: scale(0.7); opacity:0.7; }
}
</style>
</head>
<body>

<header>
    <div>
        <h1>üåç Earthquake Monitor</h1>
        <div class="subtitle">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶ì ‡¶™‡¶æ‡¶∞‡ßç‡¶∂‡ßç‡¶¨‡¶¨‡¶∞‡ßç‡¶§‡ßÄ ‡¶Ö‡¶û‡ßç‡¶ö‡¶≤</div>
    </div>
    <div class="controls">
        <button onclick="toggleTheme()">üåì Mode</button>
    </div>
</header>

<div class="status-panel">
    ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏: <span id="statusText">‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</span> | <span class="live-indicator">‚óè LIVE</span>
</div>

<div id="map"></div>

<div class="container">
    <div class="table-section">
        <h2>‚ö° ‡¶≤‡¶æ‡¶á‡¶≠ ‡ß®‡ß™ ‡¶ò‡¶®‡ßç‡¶ü‡¶æ (‡¶∏‡¶ï‡¶≤ ‡¶ï‡¶Æ‡ßç‡¶™‡¶®)</h2>
        <div id="liveLoading" class="loading">‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
        <table id="liveTable" style="display:none;">
            <thead>
                <tr>
                    <th>‡¶∏‡¶Æ‡¶Ø‡¶º (Local)</th>
                    <th>‡¶§‡ßÄ‡¶¨‡ßç‡¶∞‡¶§‡¶æ</th>
                    <th>‡¶ó‡¶≠‡ßÄ‡¶∞‡¶§‡¶æ</th>
                    <th>‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <div class="table-section">
        <h2>üìú ‡¶¨‡¶ø‡¶ó‡¶§ ‡ß©‡ß¶ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° (‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ó‡¶®‡¶ø‡¶ö‡¶ø‡¶â‡¶° > ‡ß™.‡ß¶)</h2>
        <div id="historyLoading" class="loading">‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶π‡¶ö‡ßç‡¶õ‡ßá...</div>
        <table id="historyTable" style="display:none;">
            <thead>
                <tr>
                    <th>‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ (Local)</th>
                    <th>‡¶§‡ßÄ‡¶¨‡ßç‡¶∞‡¶§‡¶æ</th>
                    <th>‡¶Ö‡¶¨‡¶∏‡ßç‡¶•‡¶æ‡¶®</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Theme
function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
    document.documentElement.setAttribute('data-theme', current);
    localStorage.setItem('theme', current);
}
document.documentElement.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');

// Map
const map = L.map('map').setView([23.6850, 90.3563], 6);
const savedTheme = document.documentElement.getAttribute('data-theme');
L.tileLayer(savedTheme === 'dark' ? 
    'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' :
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

const markersGroup = L.layerGroup().addTo(map);
const statusText = document.getElementById("statusText");

// Fetch data
async function fetchEarthquakeData() {
    statusText.innerText = "‡¶°‡¶æ‡¶ü‡¶æ ‡¶Ü‡¶®‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡¶õ‡ßá...";
    statusText.style.color = "yellow";

    const bbox = {minlat:10, maxlat:32, minlon:80, maxlon:98}; 
    const baseUrl = "https://earthquake.usgs.gov/fdsnws/event/1/query?format=geojson";

    const now = new Date();
    const nowISO = now.toISOString();
    const past24h = new Date(now.getTime() - 24*60*60*1000).toISOString();
    const past30d = new Date(now.getTime() - 30*24*60*60*1000).toISOString();

    try {
        // Live 24h
        const liveRes = await fetch(`${baseUrl}&starttime=${past24h}&endtime=${nowISO}&minmagnitude=1&maxlatitude=${bbox.maxlat}&minlatitude=${bbox.minlat}&maxlongitude=${bbox.maxlon}&minlongitude=${bbox.minlon}`);
        if(!liveRes.ok) throw new Error("Live API failed");
        const liveData = await liveRes.json();
        renderTable("liveTable","liveLoading",liveData,true);

        // History 30d
        const histRes = await fetch(`${baseUrl}&starttime=${past30d}&endtime=${past24h}&minmagnitude=4&maxlatitude=${bbox.maxlat}&minlatitude=${bbox.minlat}&maxlongitude=${bbox.maxlon}&minlongitude=${bbox.minlon}`);
        if(!histRes.ok) throw new Error("History API failed");
        const histData = await histRes.json();
        renderTable("historyTable","historyLoading",histData,false);

        statusText.innerText = "‡¶≤‡¶æ‡¶á‡¶≠ (‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ßß‡ß¶ ‡¶∏‡ßá. ‡¶Ü‡¶™‡¶°‡ßá‡¶ü)";
        statusText.style.color = "#4caf50";

    } catch(err) {
        console.error(err);
        statusText.innerText = "‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶•!";
        statusText.style.color = "red";
    }
}

// Render table + dynamic markers
function renderTable(tableId, loadingId, data, isLive) {
    const tbody = document.querySelector(`#${tableId} tbody`);
    const loadingDiv = document.getElementById(loadingId);
    const tableEl = document.getElementById(tableId);
    tbody.innerHTML = "";
    if(isLive) markersGroup.clearLayers();

    if(!data.features || data.features.length===0){
        loadingDiv.innerText = "‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø‡•§";
        tableEl.style.display="none";
        return;
    }

    loadingDiv.style.display="none";
    tableEl.style.display="table";

    data.features.forEach(q=>{
        const p = q.properties;
        const c = q.geometry.coordinates;
        const row = document.createElement("tr");

        const color = getMagColor(p.mag);
        const size = Math.max(p.mag*3,5);

        if(isLive){
            row.innerHTML = `
                <td>${new Date(p.time).toLocaleTimeString('bn-BD')}</td>
                <td style="color:${color}; font-weight:bold;">${p.mag}</td>
                <td>${c[2].toFixed(1)} km</td>
                <td>${p.place}</td>
            `;
            const circle = L.circleMarker([c[1],c[0]],{
                radius: size,
                fillColor: color,
                color:"#fff",
                weight:1,
                fillOpacity:0.7
            }).bindPopup(`<b>${p.place}</b><br>Mag: ${p.mag}<br>Depth: ${c[2].toFixed(1)}km`);
            markersGroup.addLayer(circle);

            const pulseIcon = L.divIcon({
                className:"pulse",
                iconSize:[size*2,size*2]
            });
            L.marker([c[1],c[0]],{icon:pulseIcon}).addTo(markersGroup);
        } else {
            row.innerHTML = `
                <td>${new Date(p.time).toLocaleDateString('bn-BD')}</td>
                <td style="color:${color}; font-weight:bold;">${p.mag}</td>
                <td>${p.place}</td>
            `;
        }
        tbody.appendChild(row);
    });
}

// Magnitude color gradient
function getMagColor(mag){
    if(mag>=5) return "#ff5252";
    if(mag>=4) return "#ff9800";
    return "#f1c40f";
}

// Start fetching
fetchEarthquakeData();
setInterval(fetchEarthquakeData,10000);
</script>
</body>
</html>
